name: Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install dependencies
      run: npm install

    - name: Build Docker image
      run: docker build -t devops-dynamic-website .

    - name: Log in to Amazon ECR
      run: aws ecr get-login-password --region <your-region> | docker login --username AWS --password-stdin <your-ecr-repository-url>

    - name: Push Docker image to ECR
      run: |
        docker tag devops-dynamic-website:latest <your-ecr-repository-url>:latest
        docker push <your-ecr-repository-url>:latest

    - name: Deploy to EC2 instance
      run: |
        ssh -o StrictHostKeyChecking=no ec2-user@<your-ec2-public-ip> << 'EOF'
        docker pull <your-ecr-repository-url>:latest
        docker stop $(docker ps -q) || true
        docker run -d -p 80:3000 <your-ecr-repository-url>:latest
        EOF

